<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Grbl845: protocol.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>protocol.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">  protocol.c - the serial protocol master control unit</span>
<a name="l00003"></a>00003 <span class="comment">  Part of Grbl</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">  Copyright (c) 2009-2011 Simen Svale Skogsrud</span>
<a name="l00006"></a>00006 <span class="comment">  Copyright (c) 2011-2012 Sungeun K. Jeon</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  Grbl is free software: you can redistribute it and/or modify</span>
<a name="l00009"></a>00009 <span class="comment">  it under the terms of the GNU General Public License as published by</span>
<a name="l00010"></a>00010 <span class="comment">  the Free Software Foundation, either version 3 of the License, or</span>
<a name="l00011"></a>00011 <span class="comment">  (at your option) any later version.</span>
<a name="l00012"></a>00012 <span class="comment"></span>
<a name="l00013"></a>00013 <span class="comment">  Grbl is distributed in the hope that it will be useful,</span>
<a name="l00014"></a>00014 <span class="comment">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00015"></a>00015 <span class="comment">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00016"></a>00016 <span class="comment">  GNU General Public License for more details.</span>
<a name="l00017"></a>00017 <span class="comment"></span>
<a name="l00018"></a>00018 <span class="comment">  You should have received a copy of the GNU General Public License</span>
<a name="l00019"></a>00019 <span class="comment">  along with Grbl.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00020"></a>00020 <span class="comment">*/</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;avr/io.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;protocol.h&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;gcode.h&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;serial.h&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;print.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;settings.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;config.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;nuts_bolts.h&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;avr/pgmspace.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;stepper.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;planner.h&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#define LINE_BUFFER_SIZE 50</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>
<a name="l00037"></a>00037 <span class="keyword">static</span> <span class="keywordtype">char</span> line[LINE_BUFFER_SIZE]; <span class="comment">// Line to be executed. Zero-terminated.</span>
<a name="l00038"></a>00038 <span class="keyword">static</span> uint8_t char_counter; <span class="comment">// Last character counter in line variable.</span>
<a name="l00039"></a>00039 <span class="keyword">static</span> uint8_t iscomment; <span class="comment">// Comment/block delete flag for processor to ignore comment characters.</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="keyword">static</span> <span class="keywordtype">void</span> status_message(<span class="keywordtype">int</span> status_code)
<a name="l00042"></a>00042 {
<a name="l00043"></a>00043   <span class="keywordflow">if</span> (status_code == 0) {
<a name="l00044"></a>00044     printPgmString(PSTR(<span class="stringliteral">&quot;ok\r\n&quot;</span>));
<a name="l00045"></a>00045   } <span class="keywordflow">else</span> {
<a name="l00046"></a>00046     printPgmString(PSTR(<span class="stringliteral">&quot;error: &quot;</span>));
<a name="l00047"></a>00047     <span class="keywordflow">switch</span>(status_code) {
<a name="l00048"></a>00048       <span class="keywordflow">case</span> STATUS_BAD_NUMBER_FORMAT:
<a name="l00049"></a>00049   printPgmString(PSTR(<span class="stringliteral">&quot;Bad number format\r\n&quot;</span>));
<a name="l00050"></a>00050   <span class="keywordflow">break</span>;
<a name="l00051"></a>00051       <span class="keywordflow">case</span> STATUS_EXPECTED_COMMAND_LETTER:
<a name="l00052"></a>00052   printPgmString(PSTR(<span class="stringliteral">&quot;Expected command letter\r\n&quot;</span>));
<a name="l00053"></a>00053   <span class="keywordflow">break</span>;
<a name="l00054"></a>00054       <span class="keywordflow">case</span> STATUS_UNSUPPORTED_STATEMENT:
<a name="l00055"></a>00055   printPgmString(PSTR(<span class="stringliteral">&quot;Unsupported statement\r\n&quot;</span>));
<a name="l00056"></a>00056   <span class="keywordflow">break</span>;
<a name="l00057"></a>00057       <span class="keywordflow">case</span> STATUS_FLOATING_POINT_ERROR:
<a name="l00058"></a>00058   printPgmString(PSTR(<span class="stringliteral">&quot;Floating point error\r\n&quot;</span>));
<a name="l00059"></a>00059   <span class="keywordflow">break</span>;
<a name="l00060"></a>00060       <span class="keywordflow">case</span> STATUS_MODAL_GROUP_VIOLATION:
<a name="l00061"></a>00061   printPgmString(PSTR(<span class="stringliteral">&quot;Modal group violation\r\n&quot;</span>)); <span class="keywordflow">break</span>;
<a name="l00062"></a>00062       <span class="keywordflow">case</span> STATUS_INVALID_COMMAND:
<a name="l00063"></a>00063   printPgmString(PSTR(<span class="stringliteral">&quot;Invalid command\r\n&quot;</span>));
<a name="l00064"></a>00064   <span class="keywordflow">break</span>;<span class="comment"></span>
<a name="l00065"></a>00065 <span class="comment">/// 843 : verify limit axis A</span>
<a name="l00066"></a>00066 <span class="comment"></span>   <span class="keywordflow">case</span> STATUS_BAD_NUMBER_DEGREE:
<a name="l00067"></a>00067   printPgmString(PSTR(<span class="stringliteral">&quot;Bad deggree value [-360..360] \r\n&quot;</span>));
<a name="l00068"></a>00068   <span class="keywordflow">break</span>;<span class="comment"></span>
<a name="l00069"></a>00069 <span class="comment">/// &lt;--</span>
<a name="l00070"></a>00070 <span class="comment"></span>      <span class="keywordflow">default</span>:
<a name="l00071"></a>00071   printInteger(status_code);
<a name="l00072"></a>00072   printPgmString(PSTR(<span class="stringliteral">&quot;\r\n&quot;</span>));
<a name="l00073"></a>00073     }
<a name="l00074"></a>00074   }
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="keywordtype">void</span> protocol_status_report()
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079  <span class="comment">// TODO: Status report data is written to the user here. This function should be able to grab a</span>
<a name="l00080"></a>00080  <span class="comment">// real-time snapshot of the stepper subprogram and the actual location of the CNC machine. At a</span>
<a name="l00081"></a>00081  <span class="comment">// minimum, status report should return real-time location information. Other important information</span>
<a name="l00082"></a>00082  <span class="comment">// may be distance to go on block, processed block id, and feed rate. A secondary, non-critical</span>
<a name="l00083"></a>00083  <span class="comment">// status report may include g-code state, i.e. inch mode, plane mode, absolute mode, etc.</span>
<a name="l00084"></a>00084  <span class="comment">//   The report generated must be as short as possible, yet still provide the user easily readable</span>
<a name="l00085"></a>00085  <span class="comment">// information, i.e. &#39;x0.23,y120.4,z2.4&#39;. This is necessary as it minimizes the computational</span>
<a name="l00086"></a>00086  <span class="comment">// overhead and allows grbl to keep running smoothly, especially with g-code programs with fast,</span>
<a name="l00087"></a>00087  <span class="comment">// short line segments and interface setups that require real-time status reports (5-20Hz).</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089  <span class="comment">// **Under construction** Bare-bones status report. Provides real-time machine position relative to</span>
<a name="l00090"></a>00090  <span class="comment">// the system power on location (0,0,0) and work coordinate position (G54 and G92 applied).</span>
<a name="l00091"></a>00091  <span class="comment">// The following are still needed: user setting of output units (mm|inch), compressed (non-human</span>
<a name="l00092"></a>00092  <span class="comment">// readable) data for interfaces?, save last known position in EEPROM?, code optimizations, solidify</span>
<a name="l00093"></a>00093  <span class="comment">// the reporting schemes, move to a separate .c file for easy user accessibility, and setting the</span>
<a name="l00094"></a>00094  <span class="comment">// home position by the user (likely through &#39;$&#39; setting interface).</span>
<a name="l00095"></a>00095  <span class="comment">// Successfully tested at a query rate of 10-20Hz while running a gauntlet of programs at various</span>
<a name="l00096"></a>00096  <span class="comment">// speeds.</span><span class="comment"></span>
<a name="l00097"></a>00097 <span class="comment">/// 843 : 4 -&gt; N_AXIS</span>
<a name="l00098"></a>00098 <span class="comment"></span> int32_t print_position[N_AXIS];
<a name="l00099"></a>00099  memcpy(print_position,sys.<a class="code" href="structsystem__t.html#ace7899f4cc72239557bafdefb363531f" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">position</a>,<span class="keyword">sizeof</span>(sys.<a class="code" href="structsystem__t.html#ace7899f4cc72239557bafdefb363531f" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">position</a>));  <span class="comment">///print_position = sys.position</span>
<a name="l00100"></a>00100 <span class="comment"></span><span class="preprocessor"> #if REPORT_INCH_MODE</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>   printString(<span class="stringliteral">&quot;MPos:[&quot;</span>); printFloat(print_position[X_AXIS]/(settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[X_AXIS]*MM_PER_INCH));
<a name="l00102"></a>00102    printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat(print_position[Y_AXIS]/(settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[Y_AXIS]*MM_PER_INCH));
<a name="l00103"></a>00103    printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat(print_position[Z_AXIS]/(settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[Z_AXIS]*MM_PER_INCH));
<a name="l00104"></a>00104 <span class="preprocessor"> #endif</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span><span class="comment">/// 844  : axis T</span>
<a name="l00106"></a>00106 <span class="comment"></span><span class="preprocessor">#if (AXIS_T_TYPE == LINEAR)</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>   printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat(print_position[T_AXIS]/(settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[T_AXIS]*MM_PER_INCH));
<a name="l00108"></a>00108 <span class="preprocessor">#else</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>   printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat(print_position[T_AXIS]/(settings.<a class="code" href="structsettings__t.html#a835a53105407526cc44c766c03ffb195" title="844">steps_per_degree</a>[T_AXIS]));
<a name="l00110"></a>00110 <span class="preprocessor">#endif</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span><span class="comment">/// &lt;--</span>
<a name="l00112"></a>00112 <span class="comment"></span>   printString(<span class="stringliteral">&quot;],WPos:[&quot;</span>); printFloat((print_position[X_AXIS]/settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[X_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][X_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[X_AXIS])/MM_PER_INCH);
<a name="l00113"></a>00113    printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat((print_position[Y_AXIS]/settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[Y_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][Y_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[Y_AXIS])/MM_PER_INCH);
<a name="l00114"></a>00114    printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat((print_position[Z_AXIS]/settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[Z_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][Z_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[Z_AXIS])/MM_PER_INCH);<span class="comment"></span>
<a name="l00115"></a>00115 <span class="comment">/// 844 : axis T</span>
<a name="l00116"></a>00116 <span class="comment"></span><span class="preprocessor">#if (AXIS_T_TYPE == LINEAR)</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>   printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat((print_position[T_AXIS]/settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[T_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][T_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[T_AXIS])/MM_PER_INCH);
<a name="l00118"></a>00118 <span class="preprocessor">#else</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>   printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat((print_position[T_AXIS]/settings.<a class="code" href="structsettings__t.html#a835a53105407526cc44c766c03ffb195" title="844">steps_per_degree</a>[T_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][T_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[T_AXIS]));
<a name="l00120"></a>00120 <span class="preprocessor">#endif</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span>   printString(<span class="stringliteral">&quot;MPos:[&quot;</span>); printFloat(print_position[X_AXIS]/(settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[X_AXIS]));
<a name="l00122"></a>00122    printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat(print_position[Y_AXIS]/(settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[Y_AXIS]));
<a name="l00123"></a>00123    printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat(print_position[Z_AXIS]/(settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[Z_AXIS]));<span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">/// 844 : axis T</span>
<a name="l00125"></a>00125 <span class="comment"></span>   printString(<span class="stringliteral">&quot;,&quot;</span>);
<a name="l00126"></a>00126 <span class="preprocessor">#if (AXIS_T_TYPE == LINEAR)</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>   printFloat(print_position[T_AXIS]/(settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[T_AXIS]));
<a name="l00128"></a>00128 <span class="preprocessor">#else</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>   printFloat(print_position[T_AXIS]/(settings.<a class="code" href="structsettings__t.html#a835a53105407526cc44c766c03ffb195" title="844">steps_per_degree</a>[T_AXIS]));
<a name="l00130"></a>00130 <span class="preprocessor">#endif</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>
<a name="l00132"></a>00132    printString(<span class="stringliteral">&quot;],WPos:[&quot;</span>); printFloat(print_position[X_AXIS]/settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[X_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][X_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[X_AXIS]);
<a name="l00133"></a>00133    printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat(print_position[Y_AXIS]/settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[Y_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][Y_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[Y_AXIS]);
<a name="l00134"></a>00134    printString(<span class="stringliteral">&quot;,&quot;</span>); printFloat(print_position[Z_AXIS]/settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[Z_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][Z_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[Z_AXIS]);
<a name="l00135"></a>00135    printString(<span class="stringliteral">&quot;,&quot;</span>);<span class="comment"></span>
<a name="l00136"></a>00136 <span class="comment">/// 844 : axis T</span>
<a name="l00137"></a>00137 <span class="comment"></span><span class="preprocessor">#if (AXIS_T_TYPE == LINEAR)</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>   printFloat(print_position[T_AXIS]/settings.<a class="code" href="structsettings__t.html#a7e3badd978542029870fb9596255ab74" title="843 : 4 -&amp;gt; N_AXIS, X, Y, Z, T = U xor A">steps_per_mm</a>[T_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][T_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[T_AXIS]);
<a name="l00139"></a>00139 <span class="preprocessor">#else</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>   printFloat(print_position[T_AXIS]/settings.<a class="code" href="structsettings__t.html#a835a53105407526cc44c766c03ffb195" title="844">steps_per_degree</a>[T_AXIS]-sys.<a class="code" href="structsystem__t.html#ab4344c107567531f914a5e7f032746c7" title="-&amp;gt; 843 : 4 -&amp;gt; N_AXIS">coord_system</a>[sys.<a class="code" href="structsystem__t.html#a22cf70416edfc27aac15fe02bc9ee7dc">coord_select</a>][T_AXIS]-sys.<a class="code" href="structsystem__t.html#a68ecec5eefac03dea3dc7171b2d1d273">coord_offset</a>[T_AXIS]);
<a name="l00141"></a>00141 <span class="preprocessor">#endif</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span> printString(<span class="stringliteral">&quot;]\r\n&quot;</span>);
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="keywordtype">void</span> protocol_init()
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147   <span class="comment">// Print grbl initialization message</span><span class="comment"></span>
<a name="l00148"></a>00148 <span class="comment">  /// printPgmString(PSTR(&quot;\r\nMega2560 Grbl &quot; GRBL_VERSION));</span>
<a name="l00149"></a>00149 <span class="comment">/// by  LETARTARE and DavidLQuick</span>
<a name="l00150"></a>00150 <span class="comment"></span>  <span class="comment">// Split the init message to imporove compatability with Java apps looking for the GRBL version using REGEX</span><span class="comment"></span>
<a name="l00151"></a>00151 <span class="comment">/// 845 : add the axes</span>
<a name="l00152"></a>00152 <span class="comment"></span>    printPgmString(PSTR(<span class="stringliteral">&quot;\r\nMega2560 with 4 axes &quot;</span>));
<a name="l00153"></a>00153  printPgmString(PSTR(<span class="stringliteral">&quot;\r\nGrbl &quot;</span> GRBL_VERSION <span class="stringliteral">&quot;  &quot;</span> GRBL_AXIS));<span class="comment"></span>
<a name="l00154"></a>00154 <span class="comment">/// &lt;-</span>
<a name="l00155"></a>00155 <span class="comment"></span>  printPgmString(PSTR(<span class="stringliteral">&quot;\r\n&#39;$&#39; to dump current settings\r\n&quot;</span>));
<a name="l00156"></a>00156   status_message(0);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158   char_counter = 0; <span class="comment">// Reset line input</span>
<a name="l00159"></a>00159   iscomment = <span class="keyword">false</span>;
<a name="l00160"></a>00160 }
<a name="l00161"></a>00161 
<a name="l00162"></a>00162  <span class="comment">// Executes run-time commands, when required. This is called from various check points in the main</span>
<a name="l00163"></a>00163 <span class="comment">// program, primarily where there may be a while loop waiting for a buffer to clear space or any</span>
<a name="l00164"></a>00164 <span class="comment">// point where the execution time from the last check point may be more than a fraction of a second.</span>
<a name="l00165"></a>00165 <span class="comment">// This is a way to execute runtime commands asynchronously (aka multitasking) with grbl&#39;s g-code</span>
<a name="l00166"></a>00166 <span class="comment">// parsing and planning functions. This function also serves as an interface for the interrupts to</span>
<a name="l00167"></a>00167 <span class="comment">// set the system runtime flags, where only the main program to handles them, removing the need to</span>
<a name="l00168"></a>00168 <span class="comment">// define more computationally-expensive volatile variables.</span>
<a name="l00169"></a>00169 <span class="comment">// NOTE: The sys.execute variable flags are set by the serial read subprogram, except where noted.</span>
<a name="l00170"></a>00170 <span class="keywordtype">void</span> protocol_execute_runtime()
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172   <span class="keywordflow">if</span> (sys.<a class="code" href="structsystem__t.html#aae3b4cb19307826b687519919f1c8e4f">execute</a>) { <span class="comment">// Enter only if any bit flag is true</span>
<a name="l00173"></a>00173     uint8_t rt_exec = sys.<a class="code" href="structsystem__t.html#aae3b4cb19307826b687519919f1c8e4f">execute</a>; <span class="comment">// Avoid calling volatile multiple times</span>
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="comment">// System abort. Steppers have already been force stopped.</span>
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (rt_exec &amp; EXEC_RESET) {
<a name="l00177"></a>00177       sys.<a class="code" href="structsystem__t.html#a81fb69e80457b3d6027c1de64b65b3c5">abort</a> = <span class="keyword">true</span>;
<a name="l00178"></a>00178       <span class="keywordflow">return</span>; <span class="comment">// Nothing else to do but exit.</span>
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="comment">// Execute and serial print status</span>
<a name="l00182"></a>00182     <span class="keywordflow">if</span> (rt_exec &amp; EXEC_STATUS_REPORT) {
<a name="l00183"></a>00183       protocol_status_report();
<a name="l00184"></a>00184       bit_false(sys.<a class="code" href="structsystem__t.html#aae3b4cb19307826b687519919f1c8e4f">execute</a>,EXEC_STATUS_REPORT);
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     <span class="comment">// Initiate stepper feed hold</span>
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (rt_exec &amp; EXEC_FEED_HOLD) {
<a name="l00189"></a>00189       st_feed_hold(); <span class="comment">// Initiate feed hold.</span>
<a name="l00190"></a>00190       bit_false(sys.<a class="code" href="structsystem__t.html#aae3b4cb19307826b687519919f1c8e4f">execute</a>,EXEC_FEED_HOLD);
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="comment">// Reinitializes the stepper module running flags and re-plans the buffer after a feed hold.</span>
<a name="l00194"></a>00194     <span class="comment">// NOTE: EXEC_CYCLE_STOP is set by the stepper subsystem when a cycle or feed hold completes.</span>
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (rt_exec &amp; EXEC_CYCLE_STOP) {
<a name="l00196"></a>00196       st_cycle_reinitialize();
<a name="l00197"></a>00197       bit_false(sys.<a class="code" href="structsystem__t.html#aae3b4cb19307826b687519919f1c8e4f">execute</a>,EXEC_CYCLE_STOP);
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (rt_exec &amp; EXEC_CYCLE_START) {
<a name="l00201"></a>00201       st_cycle_start(); <span class="comment">// Issue cycle start command to stepper subsystem</span>
<a name="l00202"></a>00202 <span class="preprocessor">      #ifdef CYCLE_AUTO_START</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>        sys.<a class="code" href="structsystem__t.html#a520fd8d8098cfe07fc6efb5e032758b5">auto_start</a> = <span class="keyword">true</span>; <span class="comment">// Re-enable auto start after feed hold.</span>
<a name="l00204"></a>00204 <span class="preprocessor">      #endif</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>      bit_false(sys.<a class="code" href="structsystem__t.html#aae3b4cb19307826b687519919f1c8e4f">execute</a>,EXEC_CYCLE_START);
<a name="l00206"></a>00206     }
<a name="l00207"></a>00207   }
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 <span class="comment">// Executes one line of input according to protocol</span>
<a name="l00212"></a>00212 uint8_t protocol_execute_line(<span class="keywordtype">char</span> *line)
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214   <span class="keywordflow">if</span>(line[0] == <span class="charliteral">&#39;$&#39;</span>) {
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="comment">// TODO: Re-write this &#39;$&#39; as a way to change runtime settings without having to reset, i.e.</span>
<a name="l00217"></a>00217     <span class="comment">// auto-starting, status query output formatting and type, jog mode (axes, direction, and</span>
<a name="l00218"></a>00218     <span class="comment">// nominal feedrate), toggle block delete, etc. This differs from the EEPROM settings, as they</span>
<a name="l00219"></a>00219     <span class="comment">// are considered defaults and loaded upon startup/reset.</span>
<a name="l00220"></a>00220     <span class="comment">//   This use is envisioned where &#39;$&#39; itself dumps settings and help. Defined characters</span>
<a name="l00221"></a>00221     <span class="comment">// proceeding the &#39;$&#39; may be used to setup modes, such as jog mode with a &#39;$J=X100&#39; for X-axis</span>
<a name="l00222"></a>00222     <span class="comment">// motion with a nominal feedrate of 100mm/min. Writing EEPROM settings will likely stay the</span>
<a name="l00223"></a>00223     <span class="comment">// same or similar. Should be worked out in upcoming releases.</span>
<a name="l00224"></a>00224     <span class="keywordflow">return</span>(settings_execute_line(line)); <span class="comment">// Delegate lines starting with &#39;$&#39; to the settings module</span>
<a name="l00225"></a>00225 
<a name="l00226"></a>00226   <span class="comment">// } else if {</span>
<a name="l00227"></a>00227   <span class="comment">//</span>
<a name="l00228"></a>00228   <span class="comment">// JOG MODE</span>
<a name="l00229"></a>00229   <span class="comment">//</span>
<a name="l00230"></a>00230   <span class="comment">// TODO: Here jogging can be placed for execution as a seperate subprogram. It does not need to be</span>
<a name="l00231"></a>00231   <span class="comment">// susceptible to other runtime commands except for e-stop. The jogging function is intended to</span>
<a name="l00232"></a>00232   <span class="comment">// be a basic toggle on/off with controlled acceleration and deceleration to prevent skipped</span>
<a name="l00233"></a>00233   <span class="comment">// steps. The user would supply the desired feedrate, axis to move, and direction. Toggle on would</span>
<a name="l00234"></a>00234   <span class="comment">// start motion and toggle off would initiate a deceleration to stop. One could &#39;feather&#39; the</span>
<a name="l00235"></a>00235   <span class="comment">// motion by repeatedly toggling to slow the motion to the desired location. Location data would</span>
<a name="l00236"></a>00236   <span class="comment">// need to be updated real-time and supplied to the user through status queries.</span>
<a name="l00237"></a>00237   <span class="comment">//   More controlled exact motions can be taken care of by inputting G0 or G1 commands, which are</span>
<a name="l00238"></a>00238   <span class="comment">// handled by the planner. It would be possible for the jog subprogram to insert blocks into the</span>
<a name="l00239"></a>00239   <span class="comment">// block buffer without having the planner plan them. It would need to manage de/ac-celerations</span>
<a name="l00240"></a>00240   <span class="comment">// on its own carefully. This approach could be effective and possibly size/memory efficient.</span>
<a name="l00241"></a>00241   }
<a name="l00242"></a>00242   <span class="keywordflow">else</span> {
<a name="l00243"></a>00243     <span class="keywordflow">return</span>(gc_execute_line(line));    <span class="comment">// Everything else is gcode</span>
<a name="l00244"></a>00244   }
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="comment">// Process one line of incoming serial data. Remove unneeded characters and capitalize.</span>
<a name="l00249"></a>00249 <span class="keywordtype">void</span> protocol_process()
<a name="l00250"></a>00250 {
<a name="l00251"></a>00251   uint8_t c;
<a name="l00252"></a>00252   <span class="keywordflow">while</span>((c = serial_read()) != SERIAL_NO_DATA) {
<a name="l00253"></a>00253     <span class="keywordflow">if</span> ((c == <span class="charliteral">&#39;\n&#39;</span>) || (c == <span class="charliteral">&#39;\r&#39;</span>)) { <span class="comment">// End of line reached</span>
<a name="l00254"></a>00254 
<a name="l00255"></a>00255       <span class="comment">// Runtime command check point before executing line. Prevent any furthur line executions.</span>
<a name="l00256"></a>00256       <span class="comment">// NOTE: If there is no line, this function should quickly return to the main program when</span>
<a name="l00257"></a>00257       <span class="comment">// the buffer empties of non-executable data.</span>
<a name="l00258"></a>00258       protocol_execute_runtime();
<a name="l00259"></a>00259       <span class="keywordflow">if</span> (sys.<a class="code" href="structsystem__t.html#a81fb69e80457b3d6027c1de64b65b3c5">abort</a>) { <span class="keywordflow">return</span>; } <span class="comment">// Bail to main program upon system abort</span>
<a name="l00260"></a>00260 
<a name="l00261"></a>00261       <span class="keywordflow">if</span> (char_counter &gt; 0) {<span class="comment">// Line is complete. Then execute!</span>
<a name="l00262"></a>00262         line[char_counter] = 0; <span class="comment">// Terminate string</span>
<a name="l00263"></a>00263         status_message(protocol_execute_line(line));
<a name="l00264"></a>00264       } <span class="keywordflow">else</span> {
<a name="l00265"></a>00265         <span class="comment">// Empty or comment line. Skip block.</span>
<a name="l00266"></a>00266         status_message(STATUS_OK); <span class="comment">// Send status message for syncing purposes.</span>
<a name="l00267"></a>00267       }
<a name="l00268"></a>00268       char_counter = 0; <span class="comment">// Reset line buffer index</span>
<a name="l00269"></a>00269       iscomment = <span class="keyword">false</span>; <span class="comment">// Reset comment flag</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272     <span class="keywordflow">else</span> {
<a name="l00273"></a>00273       <span class="keywordflow">if</span> (iscomment) {
<a name="l00274"></a>00274         <span class="comment">// Throw away all comment characters</span>
<a name="l00275"></a>00275         <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;)&#39;</span>) {
<a name="l00276"></a>00276           <span class="comment">// End of comment. Resume line.</span>
<a name="l00277"></a>00277           iscomment = <span class="keyword">false</span>;
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279       }
<a name="l00280"></a>00280       <span class="keywordflow">else</span> {
<a name="l00281"></a>00281         <span class="keywordflow">if</span> (c &lt;= <span class="charliteral">&#39; &#39;</span>) {
<a name="l00282"></a>00282           <span class="comment">// Throw away whitepace and control characters</span>
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;/&#39;</span>) {
<a name="l00285"></a>00285           <span class="comment">// Disable block delete and throw away characters. Will ignore until EOL.</span>
<a name="l00286"></a>00286 <span class="preprocessor">          #if BLOCK_DELETE_ENABLE</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span>            iscomment = <span class="keyword">true</span>;
<a name="l00288"></a>00288 <span class="preprocessor">          #endif</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span>        }
<a name="l00290"></a>00290         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == <span class="charliteral">&#39;(&#39;</span>) {
<a name="l00291"></a>00291           <span class="comment">// Enable comments flag and ignore all characters until &#39;)&#39; or EOL.</span>
<a name="l00292"></a>00292           iscomment = <span class="keyword">true</span>;
<a name="l00293"></a>00293         }
<a name="l00294"></a>00294         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (char_counter &gt;= LINE_BUFFER_SIZE-1) {
<a name="l00295"></a>00295           <span class="comment">// Throw away any characters beyond the end of the line buffer</span>
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c &gt;= <span class="charliteral">&#39;a&#39;</span> &amp;&amp; c &lt;= <span class="charliteral">&#39;z&#39;</span>) { <span class="comment">// Upcase lowercase</span>
<a name="l00298"></a>00298           line[char_counter++] = c-<span class="charliteral">&#39;a&#39;</span>+<span class="charliteral">&#39;A&#39;</span>;
<a name="l00299"></a>00299         }
<a name="l00300"></a>00300         <span class="keywordflow">else</span> {
<a name="l00301"></a>00301           line[char_counter++] = c;
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303       }
<a name="l00304"></a>00304     }
<a name="l00305"></a>00305   }
<a name="l00306"></a>00306 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
